#!/usr/bin/env python

import argparse
import sys
import os
import common
import difflib
import shutil

SA_CLANG_CPP = "${CLANG_PP_PATH}"  # note: this is system specific and set in cmake
SA_CLANG = "${CLANG_PATH}"  # note: this is system specific and set in cmake

if __name__ == "__main__":
    argparser = argparse.ArgumentParser("wrapper around clang and clang++ for easier cmake integration", formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    argparser.add_argument("--check_format", action="store_true", help="flag whether to check the format with clang-format")
    argparser.add_argument("--modernize", action="store_true", help="flag whether to run clang-modernize")
    argparser.add_argument("--modernize_options", type=str, default="", help="string of clang-modernize options, separated by spaces")
    argparser.add_argument("--checkers", type=str, default="", help="List of checkers", nargs="*")
    argparser.add_argument("--sa_configuration", type=str, default="", help="SA_CONFIGURATION file")
    argparser.add_argument("--disabled_checkers", type=str, default="", help="string of disabled checkers, separated by spaces", nargs="*")
    argparser.add_argument("--comparison_report_dir", type=str, default="", help="Path to the directory in which to generate comparison reports")
    argparser.add_argument("--ignore_dirs", type=str, default="", help="Directories to be omitted from SAS checks", nargs="*")
    argparser.add_argument("--do_not_compile", action="store_true", help="flag whether to use the clang compiler")
    argparser.add_argument("--source_dir", type=str, default="", help="Path to the top-level source directory")
    args, compiler_args = argparser.parse_known_args()
    command = [SA_CLANG_CPP] + compiler_args

    if args.checkers == ['']:
        args.checkers = []

    source_file_paths = []
    for argument in compiler_args:
        if common._IsSourceFile(argument):
            source_file_paths.append(argument)

    if args.disabled_checkers:
        for checker_name in args.disabled_checkers:
            command += ["-Xclang", "-analyzer-disable-checker", "-Xclang", checker_name]

    if args.sa_configuration:
        os.environ["SA_CONFIGURATION"] = args.sa_configuration

    omit_checks = False
    if(args.ignore_dirs):
        for directory in args.ignore_dirs:
            for path in source_file_paths:
                if path.startswith(directory):
                    omit_checks = True

    if omit_checks:
        retCode = common.Analyze(command, SA_CLANG_CPP, do_not_compile=args.do_not_compile, source_dir=args.source_dir)
    else:
        retCode = common.Analyze(command, SA_CLANG_CPP,
                                 format_on=args.check_format,
                                 modernize_on=args.modernize,
                                 modernize_options=args.modernize_options,
                                 sa_checkers=args.checkers,
                                 comparison_report_dir=args.comparison_report_dir,
                                 source_dir=args.source_dir,
                                 do_not_compile=args.do_not_compile)

    sys.exit(retCode)

